unit Classe.ConversorMoeda;

interface

uses
  Winapi.WinSock, System.SysUtils, System.Classes, System.JSON,
  System.Net.HttpClient, HTTPApp, IdHTTP;

type
  TConversorMoeda = class
    class function RealparaDolar(valorReal : Double) : Double;
    class function GetQuoteFromJson: Double;
  end;

implementation

const
  DollarQuoteURL = 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.10813/dados/ultimos/1?formato=json';

{ TConversorMoeda }

class function TConversorMoeda.RealparaDolar(valorReal: Double): Double;
var Quote : double;
begin
  Quote := GetQuoteFromJson;
  Result :=  valorReal/ Quote;
end;

class function TConversorMoeda.GetQuoteFromJson: Double;
var
   HttpClient: THttpClient;
   HttpResponse: IHttpResponse;
   DollarQuoteJson : TJSONArray;
begin
  try
    HttpClient := THTTPClient.Create;
    HttpResponse := HttpClient.Get(DollarQuoteURL);

    DollarQuoteJson := TJSONObject.ParseJSONValue(HttpResponse.ContentAsString) as TJSONArray;
    try
      Result := DollarQuoteJson.Items[0].GetValue<Double>('valor');
    finally
      DollarQuoteJson.Free;
      HttpClient.Free;
    end;
  except on E: Exception do
    Result := 0;
  end;
end;

end.
